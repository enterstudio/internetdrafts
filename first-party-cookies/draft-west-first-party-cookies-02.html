<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>First-Party-Only Cookies</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Goals"/>
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Limitations"/>
<link href="#rfc.section.1.3" rel="Chapter" title="1.3 Examples"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Terminology and notation"/>
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 First-party and Third-party Requests"/>
<link href="#rfc.section.2.1.1" rel="Chapter" title="2.1.1 Document-based requests"/>
<link href="#rfc.section.2.1.2" rel="Chapter" title="2.1.2 Worker-based requests"/>
<link href="#rfc.section.3" rel="Chapter" title="3 Server Requirements"/>
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Grammar"/>
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Semantics of the &#x201C;First-Party-Only&#x201D; Attribute (Non-Normative)"/>
<link href="#rfc.section.4" rel="Chapter" title="4 User Agent Requirements"/>
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 The &#x201C;First-Party&#x201D; attribute"/>
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Monkey-patching the Storage Model"/>
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Monkey-patching the &#x201C;Cookie&#x201D; header"/>
<link href="#rfc.section.5" rel="Chapter" title="5 Authoring Considerations"/>
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Mashups and Widgets"/>
<link href="#rfc.section.6" rel="Chapter" title="6 Privacy Considerations"/>
<link href="#rfc.references" rel="Chapter" title="7 References"/>
<link href="#rfc.references.1" rel="Chapter" title="7.1 Normative References"/>
<link href="#rfc.references.2" rel="Chapter" title="7.2 Informative References"/>
<link href="#rfc.appendix.A" rel="Chapter" title="A Acknowledgements"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.4.8 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="West, M." />
  <meta name="dct.identifier" content="urn:ietf:id:draft-west-first-party-cookies-02" />
  <meta name="dct.issued" scheme="ISO8601" content="2015-4-15" />
  <meta name="dct.abstract" content="This document updates RFC6265 by defining a " />
  <meta name="description" content="This document updates RFC6265 by defining a " />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">HTTPbis</td>
  <td class="right">M. West</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">Google, Inc</td>
</tr>
<tr>
  <td class="left">Updates: 6265 (if approved)</td>
  <td class="right">April 15, 2015</td>
</tr>
<tr>
  <td class="left">Intended status: Standards Track</td>
  <td class="right"></td>
</tr>
<tr>
  <td class="left">Expires: October 17, 2015</td>
  <td class="right"></td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">First-Party-Only Cookies<br />
  <span class="filename">draft-west-first-party-cookies-02</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This document updates RFC6265 by defining a <samp>First-Party-Only</samp> attribute which allows servers to assert that a cookie ought to be sent only in a &#8220;first-party&#8221; context. This assertion allows user agents to mitigate the risk of cross-origin information leakage, and provides some minimal protection against cross-site request forgery attacks.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on October 17, 2015.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2015 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>1.1.   <a href="#rfc.section.1.1">Goals</a></li>
<li>1.2.   <a href="#rfc.section.1.2">Limitations</a></li>
<li>1.3.   <a href="#rfc.section.1.3">Examples</a></li>
<li>2.   <a href="#rfc.section.2">Terminology and notation</a></li>
<li>2.1.   <a href="#rfc.section.2.1">First-party and Third-party Requests</a></li>
<li>2.1.1.   <a href="#rfc.section.2.1.1">Document-based requests</a></li>
<li>2.1.2.   <a href="#rfc.section.2.1.2">Worker-based requests</a></li>
<li>3.   <a href="#rfc.section.3">Server Requirements</a></li>
<li>3.1.   <a href="#rfc.section.3.1">Grammar</a></li>
<li>3.2.   <a href="#rfc.section.3.2">Semantics of the &#8220;First-Party-Only&#8221; Attribute (Non-Normative)</a></li>
<li>4.   <a href="#rfc.section.4">User Agent Requirements</a></li>
<li>4.1.   <a href="#rfc.section.4.1">The &#8220;First-Party&#8221; attribute</a></li>
<li>4.2.   <a href="#rfc.section.4.2">Monkey-patching the Storage Model</a></li>
<li>4.3.   <a href="#rfc.section.4.3">Monkey-patching the &#8220;Cookie&#8221; header</a></li>
<li>5.   <a href="#rfc.section.5">Authoring Considerations</a></li>
<li>5.1.   <a href="#rfc.section.5.1">Mashups and Widgets</a></li>
<li>6.   <a href="#rfc.section.6">Privacy Considerations</a></li>
<li>7.   <a href="#rfc.references">References</a></li>
<li>7.1.   <a href="#rfc.references.1">Normative References</a></li>
<li>7.2.   <a href="#rfc.references.2">Informative References</a></li>
<li>Appendix A.   <a href="#rfc.appendix.A">Acknowledgements</a></li>
<li><a href="#rfc.authors">Author's Address</a></li>


  </ul>

  <h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a></h1>
<p id="rfc.section.1.p.1">Section 8.2 of <a href="#RFC6265">[RFC6265]</a> eloquently notes that cookies are a form of ambient authority, attached by default to requests the user agent sends on a user&#8217;s behalf. Even when an attacker doesn&#8217;t know the contents of a user&#8217;s cookies, she can still execute commands on the user&#8217;s behalf (and with the user&#8217;s authority) by asking the user agent to send HTTP requests to unwary servers.</p>
<p id="rfc.section.1.p.2">Here, we update <a href="#RFC6265">[RFC6265]</a> with a simple mitigation strategy that allows servers to declare certain cookies as &#8220;First-party-only&#8221;, meaning they should be attached to requests if and only if those requests occur in a first-party context (as defined in section 2.1).</p>
<p id="rfc.section.1.p.3">Note that the mechanism outlined here is backwards compatible with the existing cookie syntax. Servers may serve first-party cookies to all user agents; those that do not support the <samp>First-Party-Only</samp> attribute will simply store a cookie which is returned in all applicable contexts, just as they do today.</p>
<h1 id="rfc.section.1.1"><a href="#rfc.section.1.1">1.1.</a> <a href="#goals" id="goals">Goals</a></h1>
<p id="rfc.section.1.1.p.1">These first-party-only cookies are intended to provide a solid layer of defense-in-depth against attacks which require embedding an authenticated request into an attacker-controlled context:</p>
<p/>

<ol>
  <li>Timing attacks which yield cross-origin information leakage (such as those detailed in <a href="#pixel-perfect">[pixel-perfect]</a>) can be substantially mitigated by setting the <samp>First-Party-Only</samp> attribute on authentication cookies. The attacker will only be able to embed unauthenticated resources, as embedding mechanisms such as <samp>&lt;iframe&gt;</samp> will not create first-party contexts.</li>
  <li>Cross-site script inclusion (XSSI) attacks are likewise mitigated by setting the <samp>First-Party-Only</samp> attribute on authentication cookies. The attacker will not be able to include authenticated resources via <samp>&lt;script&gt;</samp> or <samp>&lt;link&gt;</samp>, as these embedding mechanisms will not create first-party contexts.</li>
</ol>
<p id="rfc.section.1.1.p.3">First-party-only cookies also mitigate one specific kind of cross-site request forgery (CSRF) attack by treating cross-origin <samp>POST</samp> requests (including navigations) as as third-party requests.</p>
<p id="rfc.section.1.1.p.4">Aside from these attack mitigations, first-party-only cookies can also be useful for policy or regulatory purposes. That is, it may be valuable for an origin to assert that its cookies should not be sent along with third-party requests in order to limit its exposure to non-technical risk.</p>
<h1 id="rfc.section.1.2"><a href="#rfc.section.1.2">1.2.</a> <a href="#limitations" id="limitations">Limitations</a></h1>
<p id="rfc.section.1.2.p.1">First-party-only cookies provide limited defense against one kind of na&#239;ve cross-site request forgery attack (CSRF). It does not offer a robust defense against CSRF as a general category of attack:</p>
<p/>

<ol>
  <li>Attackers can still pop up new windows or trigger top-level navigations in order to create a first-party context (as described in section 2.1), which is only a speedbump along the road to exploitation.</li>
  <li>Features like <samp>&lt;link rel='prerender'&gt;</samp> <a href="#prerendering">[prerendering]</a> can be exploited to create first-party contexts without the risk of user detection.</li>
</ol>
<p id="rfc.section.1.2.p.3">In addition to the usual server-side defenses (CSRF tokens, etc), client-side techniques such as those described in <a href="#app-isolation">[app-isolation]</a> may prove effective against CSRF, and are certainly worth exploring in combination with first-party-only cookies. First-party-only cookies on their own, however, are not a substantial barrier to CSRF attacks.</p>
<h1 id="rfc.section.1.3"><a href="#rfc.section.1.3">1.3.</a> <a href="#examples" id="examples">Examples</a></h1>
<p id="rfc.section.1.3.p.1">First-party-only cookies are set via the <samp>First-Party-Only</samp> attribute in the <samp>Set-Cookie</samp> header field. That is, given a server&#8217;s response to a user agent which contains the following header field:</p>
<pre>
Set-Cookie: SID=31d4d96e407aad42; First-Party-Only
</pre>
<p id="rfc.section.1.3.p.2">Subsequent requests from that user agent can be expected to contain the following header field if and only if both the requested resource and the resource in the top-level browsing context match the cookie.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#terminology-and-notation" id="terminology-and-notation">Terminology and notation</a></h1>
<p id="rfc.section.2.p.1">The key words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;REQUIRED&#8221;, &#8220;SHALL&#8221;, &#8220;SHALL NOT&#8221;, &#8220;SHOULD&#8221;, &#8220;SHOULD NOT&#8221;, &#8220;RECOMMENDED&#8221;, &#8220;MAY&#8221;, and &#8220;OPTIONAL&#8221; in this document are to be interpreted as described in <a href="#RFC2119">[RFC2119]</a>.</p>
<p id="rfc.section.2.p.2">This specification uses the Augmented Backus-Naur Form (ABNF) notation of <a href="#RFC5234">[RFC5234]</a>.</p>
<p id="rfc.section.2.p.3">Two sequences of octets are said to case-insensitively match each other if and only if they are equivalent under the <samp>i;ascii-casemap</samp> collation defined in <a href="#RFC4790">[RFC4790]</a>.</p>
<p id="rfc.section.2.p.4">The terms &#8220;active document&#8221;, &#8220;ancestor browsing context&#8221;, &#8220;browsing context&#8221;, &#8220;document&#8221;, &#8220;iframe srcdoc document&#8221;, &#8220;parent browsing context&#8221;, and &#8220;top-level browsing context&#8221; are defined in the HTML Living Standard <a href="#HTML">[HTML]</a>.</p>
<p id="rfc.section.2.p.5">&#8220;Web Workers&#8221;, &#8220;dedicated workers&#8221;, &#8220;owner document&#8221;, &#8220;list of relevant documents&#8221;, and &#8220;shared workers&#8221; are defined in the Web Workers specification <a href="#WORKERS">[WORKERS]</a>.</p>
<p id="rfc.section.2.p.6">&#8220;Service Workers&#8221; are defined in the Service Workers specification <a href="#SERVICE-WORKERS">[SERVICE-WORKERS]</a>.</p>
<p id="rfc.section.2.p.7">The term &#8220;origin&#8221;, the mechanism of deriving an origin from a URI, and the &#8220;the same&#8221; matching algorithm for origins are defined in <a href="#RFC6454">[RFC6454]</a>.</p>
<h1 id="rfc.section.2.1"><a href="#rfc.section.2.1">2.1.</a> <a href="#first-and-third-party" id="first-and-third-party">First-party and Third-party Requests</a></h1>
<h1 id="rfc.section.2.1.1"><a href="#rfc.section.2.1.1">2.1.1.</a> <a href="#document-based-requests" id="document-based-requests">Document-based requests</a></h1>
<p id="rfc.section.2.1.1.p.1">When considering a request generated while parsing a document, or executing script in its context, we need to consider the document&#8217;s origin as well as the origin of each of it&#8217;s ancestors, in order to determine whether the request should be considered &#8220;first-party&#8221;.</p>
<p id="rfc.section.2.1.1.p.2">For this kind of request, the URI displayed in a user agent&#8217;s address bar is the only security context directly exposed to users, and therefore the only signal users can reasonably rely upon to determine whether or not they trust a particular website. The origin of that URI is, therefore, the &#8220;first-party origin&#8221;.</p>
<p id="rfc.section.2.1.1.p.3">In order to prevent the kinds of &#8220;multiple-nested scenarios&#8221; described in Section 4 of <a href="#RFC7034">[RFC7034]</a>, we must check the first-party origin against the origins of each of a document&#8217;s ancestor browsing contexts&#8217; active documents.  A document is considered a &#8220;first-party context&#8221; if and only if the origin of its URI is the same as the first-party origin, <strong>and</strong> if each of the active documents in its ancestors&#8217; browsing contexts&#8217; is a first-party context.</p>
<p id="rfc.section.2.1.1.p.4">This definition has a few implications:</p>
<p/>

<ul>
  <li>New windows create new first-party contexts (as the active document is rendered into a top-level browsing context).</li>
  <li>Full-page navigations create new first-party contexts. Notably, this includes both HTTP and <samp>&lt;meta&gt;</samp>-driven redirects.</li>
  <li><samp>&lt;iframe&gt;</samp>s do not create new first-party contexts; their requests MUST be considered in the context of the origin of the URL the user actually sees in the user agent&#8217;s address bar.</li>
</ul>
<p id="rfc.section.2.1.1.p.6">To be more precise, given an HTTP request <samp>request</samp>, the following algorithm returns <samp>First-Party</samp> if <samp>request</samp> is a first-party request, and <samp>Third-Party</samp> otherwise:</p>
<p/>

<ol>
  <li>Let <samp>document</samp> be the document responsible for <samp>request</samp>.</li>
  <li>If <samp>document</samp> is a first-party context, and <samp>request</samp>&#8217;s URI&#8217;s origin is the same as the origin of the URI of the active document in the top-level browsing context of <samp>document</samp>, then return <samp>First-Party</samp>.</li>
  <li>Return <samp>Third-Party</samp>.</li>
</ol>
<p id="rfc.section.2.1.1.p.8">Given a Document <samp>document</samp>, the following algorithm returns <samp>First-Party</samp> if <samp>document</samp> is a first-party context, and <samp>Third-Party</samp> otherwise:</p>
<p/>

<ol>
  <li>Let <samp>top-origin</samp> be the origin of the URI of the active document in the top-level browsing context of the document responsible for <samp>request</samp>.</li>
  <li>If <samp>document</samp>&#8217;s URI&#8217;s origin is not <samp>top-origin</samp>, return <samp>Third-Party</samp>.</li>
  <li>While <samp>document</samp> has a parent browsing context:  <ol><li>Let <samp>document</samp> be <samp>document</samp>&#8217;s parent browsing context&#8217;s active document.</li><li>If <samp>document</samp>&#8217;s URI&#8217;s origin is not <samp>top-origin</samp> and <samp>document</samp> is not an iframe srcdoc document, return <samp>Third-Party</samp>.</li></ol></li>
  <li>Return <samp>First-Party</samp>.</li>
</ol>
<p id="rfc.section.2.1.1.p.10">Note that we deal with the document&#8217;s location in steps 2, 3, and 4.2 above, not with the document&#8217;s origin. For example, a top-level document from <samp>https://example.com</samp> which has been sandboxed into a unique origin still creates a non-unique first-party context for subsequent requests.</p>
<h1 id="rfc.section.2.1.2"><a href="#rfc.section.2.1.2">2.1.2.</a> <a href="#worker-based-requests" id="worker-based-requests">Worker-based requests</a></h1>
<p id="rfc.section.2.1.2.p.1">Worker-driven requests aren&#8217;t as clear-cut as document-driven requests, as there isn&#8217;t a clear link between a top-level browsing context and a worker.  This is especially true for Service Workers <a href="#SERVICE-WORKERS">[SERVICE-WORKERS]</a>, which may execute code in the background, without any document visible at all.</p>
<p id="rfc.section.2.1.2.p.2">Note: The descriptions below assume that workers must be same-origin with the documents that instantiate them. If this invariant changes, we&#8217;ll need to take the worker&#8217;s script&#8217;s URI into account when determining their status.</p>
<h1 id="rfc.section.2.1.2.1"><a href="#rfc.section.2.1.2.1">2.1.2.1.</a> <a href="#dedicated-workers" id="dedicated-workers">Dedicated Workers</a></h1>
<p id="rfc.section.2.1.2.1.p.1">Dedicated workers are fairly straightforward to categorize, as each dedicated worker is bound to one and only one Document. Requests generated from a dedicated worker (via <samp>importScripts</samp>, <samp>XMLHttpRequest</samp>, <samp>fetch()</samp>, and so on) are first-party requests if and only if the worker&#8217;s owner document is a first-party context.</p>
<p id="rfc.section.2.1.2.1.p.2">To be more precise, given an HTTP request <samp>request</samp>, the following algorithm returns <samp>First-Party</samp> if <samp>request</samp> is a first-party request, and <samp>Third-Party</samp> otherwise:</p>
<p/>

<ol>
  <li>Let <samp>worker</samp> be the dedicated worker responsible for <samp>request</samp>.</li>
  <li>Let <samp>document</samp> be <samp>worker</samp>&#8217;s owner document.</li>
  <li>If <samp>document</samp> is a first-party context, and <samp>request</samp>&#8217;s URI&#8217;s origin is the same as the origin of the URI of the active document in the top-level browsing context of <samp>document</samp>, then return <samp>First-Party</samp>.</li>
  <li>Return <samp>Third-Party</samp>.</li>
</ol>
<h1 id="rfc.section.2.1.2.2"><a href="#rfc.section.2.1.2.2">2.1.2.2.</a> <a href="#shared-workers" id="shared-workers">Shared Workers</a></h1>
<p id="rfc.section.2.1.2.2.p.1">Shared Workers introduce the complexity of bindings to multiple Documents. As it is quite possible for a shared worker to be bound at the same time to one Document that is a first-party context, and another that isn&#8217;t, we&#8217;ll need to walk through all the documents associated with the worker to determine its status. If and only if all associated documents are first-party contexts, then the worker is a first-party context.</p>
<p id="rfc.section.2.1.2.2.p.2">To be more precise, given an HTTP request <samp>request</samp>, the following algorithm returns <samp>First-Party</samp> if <samp>request</samp> is a first-party request, and <samp>Third-Party</samp> otherwise:</p>
<p/>

<ol>
  <li>Let <samp>worker</samp> be the dedicated worker responsible for <samp>request</samp>.</li>
  <li>For each <samp>document</samp> in <samp>worker</samp>&#8217;s list of relevant Documents:  <ol><li>Return <samp>Third-Party</samp> if <samp>document</samp> is not a first-party context (as defined in section 2.1.1).</li><li>Return <samp>Third-Party</samp> if <samp>request</samp>&#8217;s URI&#8217;s origin is not the same as the origin of the URI of the active document in the top-level browsing context of <samp>document</samp>.</li></ol></li>
  <li>Return <samp>First-Party</samp>.</li>
</ol>
<h1 id="rfc.section.2.1.2.3"><a href="#rfc.section.2.1.2.3">2.1.2.3.</a> <a href="#service-workers" id="service-workers">Service Workers</a></h1>
<p id="rfc.section.2.1.2.3.p.1">Service Workers are more complex still, as they act as a completely separate execution context, with very little relationship to the Document which registered them.</p>
<p id="rfc.section.2.1.2.3.p.2">Until we have more implementation experience, we will consider Service Workers as third-party contexts in all cases.</p>
<p id="rfc.section.2.1.2.3.p.3">Note: Requests which simply pass through a service worker will be handled as described above; the only requests which will be effected by this categorization are those which the service worker itself initiates (via <samp>fetch()</samp>, for instance).</p>
<h1 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#server-requirements" id="server-requirements">Server Requirements</a></h1>
<p id="rfc.section.3.p.1">This section describes extensions to <a href="#RFC6265">[RFC6265]</a> necessary to implement the server-side requirements of the <samp>First-Party-Only</samp> attribute.</p>
<h1 id="rfc.section.3.1"><a href="#rfc.section.3.1">3.1.</a> <a href="#grammar" id="grammar">Grammar</a></h1>
<p id="rfc.section.3.1.p.1">Add <samp>First-Party-Only</samp> to the list of accepted attributes in the <samp>Set-Cookie</samp> header field&#8217;s value by replacing the <samp>cookie-av</samp> token definition in Section 4.1.1 of <a href="#RFC6265">[RFC6265]</a> with the following ABNF grammar:</p>
<pre>
cookie-av           = expires-av / max-age-av / domain-av /
                      path-av / secure-av / httponly-av /
                      first-party-only-av / extension-av
first-party-only-av = "First-Party-Only"
</pre>
<h1 id="rfc.section.3.2"><a href="#rfc.section.3.2">3.2.</a> <a href="#semantics-of-the-first-party-only-attribute-non-normative" id="semantics-of-the-first-party-only-attribute-non-normative">Semantics of the &#8220;First-Party-Only&#8221; Attribute (Non-Normative)</a></h1>
<p id="rfc.section.3.2.p.1">The &#8220;First-Party-Only&#8221; attribute limits the scope of the cookie such that it will only be attached to requests if those requests are &#8220;first-party&#8221;, as described in <a href="#first-and-third-party">Section 2.1</a>. For example, requests for <samp>https://example.com/sekrit-image</samp> will attach first-party-only cookies if and only if the top-level browsing context is currently displaying a document from <samp>https://example.com</samp>.</p>
<p id="rfc.section.3.2.p.2">The changes to the <samp>Cookie</samp> header field suggested in <a href="#cookie-header">Section 4.3</a> provide additional detail.</p>
<h1 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#user-agent-requirements" id="user-agent-requirements">User Agent Requirements</a></h1>
<p id="rfc.section.4.p.1">This section describes extensions to <a href="#RFC6265">[RFC6265]</a> necessary in order to implement the client-side requirements of the <samp>First-Party-Only</samp> attribute.</p>
<h1 id="rfc.section.4.1"><a href="#rfc.section.4.1">4.1.</a> <a href="#the-first-party-attribute" id="the-first-party-attribute">The &#8220;First-Party&#8221; attribute</a></h1>
<p id="rfc.section.4.1.p.1">The following attribute definition should be considered part of the the <samp>Set-Cookie</samp> algorithm as described in Section 5.2 of <a href="#RFC6265">[RFC6265]</a>:</p>
<p id="rfc.section.4.1.p.2">If the attribute-name case-insensitively matches the string &#8220;First-Party-Only&#8221;, the user agent MUST append an attribute to the <samp>cookie-attribute-list</samp> with an <samp>attribute-name</samp> of &#8220;First-Party-Only&#8221; and an empty <samp>attribute-value</samp>.</p>
<h1 id="rfc.section.4.2"><a href="#rfc.section.4.2">4.2.</a> <a href="#monkey-patching-the-storage-model" id="monkey-patching-the-storage-model">Monkey-patching the Storage Model</a></h1>
<p id="rfc.section.4.2.p.1">Note: There&#8217;s got to be a better way to specify this. Until I figure out what that is, monkey-patching!</p>
<p id="rfc.section.4.2.p.2">Alter Section 5.3 of <a href="#RFC6265">[RFC6265]</a> as follows:</p>
<p/>

<ol>
  <li>Add <samp>first-party-only-flag</samp> to the list of fields stored for each cookie.</li>
  <li>Before step 11 of the current algorithm, add the following:  <ol><li>If the <samp>cookie-attribute-list</samp> contains an attribute with an <samp>attribute-name</samp> of &#8220;First-Party-Only&#8221;, set the cookie&#8217;s <samp>first-party-only-flag</samp> to true. Otherwise, set the cookie&#8217;s <samp>first-party-only-flag</samp> to false.</li><li>If the cookie&#8217;s <samp>first-party-only-flag</samp> is set to true, and the request which generated the cookie is not a first-party request (as defined in <a href="#first-and-third-party">Section 2.1</a>), then abort these steps and ignore the newly created cookie entirely.</li></ol></li>
</ol>
<h1 id="rfc.section.4.3"><a href="#rfc.section.4.3">4.3.</a> <a href="#cookie-header" id="cookie-header">Monkey-patching the &#8220;Cookie&#8221; header</a></h1>
<p id="rfc.section.4.3.p.1">Note: There&#8217;s got to be a better way to specify this. Until I figure out what that is, monkey-patching!</p>
<p id="rfc.section.4.3.p.2">Alter Section 5.4 of <a href="#RFC6265">[RFC6265]</a> as follows:</p>
<p/>

<ol>
  <li>Add the following requirements to the list in step 1:  <ul><li>If the cookie&#8217;s <samp>first-party-only-flag</samp> is true, then exclude the cookie if the HTTP request is a third-party request (see <a href="#first-and-third-party">Section 2.1</a>).</li><li>If the cookie&#8217;s <samp>first-party-only-flag</samp> is true, then exclude the cookie if the HTTP request&#8217;s method is not <samp>GET</samp> and the origin of the document which originated the request is not the same as the origin of the HTTP request&#8217;s URI.</li></ul></li>
</ol>
<p id="rfc.section.4.3.p.4">Note that the modifications suggested here concern themselves only with the origins of ancestor browsing contexts and the origin of the resource being requested. The cookie&#8217;s <samp>domain</samp>, <samp>path</samp>, and <samp>secure</samp> attributes do not come into play for these comparisons.</p>
<h1 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#authoring-considerations" id="authoring-considerations">Authoring Considerations</a></h1>
<h1 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a> <a href="#mashups-and-widgets" id="mashups-and-widgets">Mashups and Widgets</a></h1>
<p id="rfc.section.5.1.p.1">The <samp>First-Party-Only</samp> attribute is inappropriate for some important use-cases.  In particular, note that content intended for embedding in a third-party context (social networking widgets or commenting services, for instance) will not have access to first-party-only cookies. Non-first-party cookies may be required in order to provide seamless functionality that relies on a user&#8217;s state.</p>
<p id="rfc.section.5.1.p.2">Likewise, some forms of Single-Sign On might require authentication in a third-party context; these mechanisms will not function as intended with first-party-only cookies.</p>
<h1 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#privacy-considerations" id="privacy-considerations">Privacy Considerations</a></h1>
<p id="rfc.section.6.p.1">First-party-only cookies in and of themselves don&#8217;t do anything to address the general privacy concerns outlined in Section 7.1 of <a href="#RFC6265">[RFC6265]</a>. The attribute is set by the server, and serves to mitigate the risk of certain kinds of attacks that the server is worried about. The user is not involved in this decision. Moreover, a number of side-channels exist which could allow a server to link distinct requests even in the absence of cookies. Connection and/or socket pooling, Token Binding, and Channel ID all offer explicit methods of identification that servers could take advantage of.</p>
<h1 id="rfc.references"><a href="#rfc.references">7.</a> References</h1>
<h1 id="rfc.references.1"><a href="#rfc.references.1">7.1.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="HTML">[HTML]</b>
      </td>
      <td class="top"><a title="Google, Inc.">Hickson, I.</a>, "<a href="https://html.spec.whatwg.org/">HTML Living Standard</a>", n.d..</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC2119">[RFC2119]</b>
      </td>
      <td class="top"><a href="mailto:sob@harvard.edu" title="Harvard University">Bradner, S.</a>, "<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, March 1997.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4790">[RFC4790]</b>
      </td>
      <td class="top"><a>Newman, C.</a>, <a>Duerst, M.</a> and <a>A. Gulbrandsen</a>, "<a href="http://tools.ietf.org/html/rfc4790">Internet Application Protocol Collation Registry</a>", RFC 4790, March 2007.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5234">[RFC5234]</b>
      </td>
      <td class="top"><a>Crocker, D.</a> and <a>P. Overell</a>, "<a href="http://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>", STD 68, RFC 5234, January 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6265">[RFC6265]</b>
      </td>
      <td class="top"><a>Barth, A.</a>, "<a href="http://tools.ietf.org/html/rfc6265">HTTP State Management Mechanism</a>", RFC 6265, April 2011.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6454">[RFC6454]</b>
      </td>
      <td class="top"><a>Barth, A.</a>, "<a href="http://tools.ietf.org/html/rfc6454">The Web Origin Concept</a>", RFC 6454, December 2011.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7034">[RFC7034]</b>
      </td>
      <td class="top"><a>Ross, D.</a> and <a>T. Gondrom</a>, "<a href="http://tools.ietf.org/html/rfc7034">HTTP Header Field X-Frame-Options</a>", RFC 7034, October 2013.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="SERVICE-WORKERS">[SERVICE-WORKERS]</b>
      </td>
      <td class="top"><a>Russell, A.</a>, <a>Song, J.</a> and <a>J. Archibald</a>, "<a href="http://www.w3.org/TR/service-workers/">Service Workers</a>", n.d..</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="WORKERS">[WORKERS]</b>
      </td>
      <td class="top"><a>Hickson, I.</a>, "<a href="http://www.w3.org/TR/workers/">Web Workers</a>", n.d..</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.references.2"><a href="#rfc.references.2">7.2.</a> Informative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="app-isolation">[app-isolation]</b>
      </td>
      <td class="top"><a>Chen, E.</a>, <a>Bau, J.</a>, <a>Reis, C.</a>, <a>Barth, A.</a> and <a>C. Jackson</a>, "<a href="http://www.collinjackson.com/research/papers/appisolation.pdf">App Isolation - Get the Security of Multiple Browsers with Just One</a>", n.d..</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="pixel-perfect">[pixel-perfect]</b>
      </td>
      <td class="top"><a>Stone, P.</a>, "<a href="http://www.contextis.com/documents/2/Browser_Timing_Attacks.pdf">Pixel Perfect Timing Attacks with HTML5</a>", n.d..</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="prerendering">[prerendering]</b>
      </td>
      <td class="top"><a>Bentzel, C.</a>, "<a href="https://www.chromium.org/developers/design-documents/prerender">Chrome Prerendering</a>", n.d..</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="samedomain-cookies">[samedomain-cookies]</b>
      </td>
      <td class="top"><a>Goodwin, M.</a> and <a>J. Walker</a>, "<a href="http://people.mozilla.org/~mgoodwin/SameDomain/samedomain-latest.txt">SameDomain Cookie Flag</a>", 2011.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.appendix.A"><a href="#rfc.appendix.A">Appendix A.</a> <a href="#acknowledgements" id="acknowledgements">Acknowledgements</a></h1>
<p id="rfc.section.A.p.1">The first-party cookie concept documented here is indebited to Mark Goodwin&#8217;s and Joe Walker&#8217;s <a href="#samedomain-cookies">[samedomain-cookies]</a>. Michal Zalewski, Artur Janc, and Ryan Sleevi provided particularly valuable feedback on this document.</p>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Author's Address</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Mike West</span> 
	  <span class="n hidden">
		<span class="family-name">West</span>
	  </span>
	</span>
	<span class="org vcardline">Google, Inc</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:mkwst@google.com">mkwst@google.com</a></span>

<span class="vcardline">URI: <a href="https://mikewest.org/">https://mikewest.org/</a></span>

  </address>
</div>

</body>
</html>
